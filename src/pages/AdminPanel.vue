<template>
  <div class="admin-panel">
    <!-- È°µÈù¢Â§¥ÈÉ® -->
    <div class="page-header">
      <div class="header-content">
        <div class="header-left">
          <h1>ÁÆ°ÁêÜÂëòÈù¢Êùø</h1>
          <p class="subtitle">ÁÆ°ÁêÜÁæ§ÊàêÂëò‰ø°ÊÅØ</p>
        </div>
        <div class="header-actions">
          <el-button @click="showGroupLeaderDialog">
            <el-icon><Crown /></el-icon>
            ËÆæÁΩÆÁæ§‰∏ª
          </el-button>
          <el-button @click="goToMessageManagement">
            <el-icon><ChatDotRound /></el-icon>
            ÁïôË®ÄÁÆ°ÁêÜ
          </el-button>
          <el-button type="primary" @click="showAddDialog">
            <el-icon><Plus /></el-icon>
            Ê∑ªÂä†ÊàêÂëò
          </el-button>
        </div>
      </div>
    </div>

    <!-- ÁªüËÆ°Âç°Áâá -->
    <el-row :gutter="16" class="stats-row">
      <el-col :span="6">
        <el-card class="stat-card">
          <el-statistic 
            title="ÊÄªÊàêÂëòÊï∞" 
            :value="memberStore.memberCount"
            :value-style="{ color: '#409eff' }"
          >
            <template #prefix>
              <el-icon><User /></el-icon>
            </template>
          </el-statistic>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card class="stat-card">
          <el-statistic 
            title="Âú∞Âå∫Êï∞Èáè" 
            :value="locationCount"
            :value-style="{ color: '#67c23a' }"
          >
            <template #prefix>
              <el-icon><Location /></el-icon>
            </template>
          </el-statistic>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card class="stat-card">
          <el-statistic 
            title="Êú¨ÊúàÊñ∞Â¢û" 
            :value="thisMonthCount"
            :value-style="{ color: '#e6a23c' }"
          >
            <template #prefix>
              <el-icon><TrendCharts /></el-icon>
            </template>
          </el-statistic>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card class="stat-card">
          <el-statistic 
            :title="`ÂΩìÂâçÁæ§‰∏ª`"
            :value="currentGroupLeaderName"
            :value-style="{ color: '#f5c842', fontSize: '18px', fontWeight: '600' }"
          >
            <template #prefix>
              <img src="/crown.png" style="width: 20px; height: 20px; margin-right: 8px;" />
            </template>
          </el-statistic>
        </el-card>
      </el-col>
    </el-row>

    <!-- ÊàêÂëòÁÆ°ÁêÜË°®Ê†º -->
    <el-card class="table-card">
      <template #header>
        <div class="card-header">
          <span>ÊàêÂëòÂàóË°®</span>
          <el-input
            v-model="searchText"
            placeholder="ÊêúÁ¥¢ÊàêÂëò..."
            style="width: 250px"
            prefix-icon="Search"
            clearable
          />
        </div>
      </template>

      <el-table 
        :data="filteredTableData" 
        v-loading="memberStore.loading"
        stripe
        style="width: 100%"
      >
        <el-table-column width="80">
          <template #default="{ row }">
            <el-avatar :size="50" :src="row.avatar">
              <el-icon><User /></el-icon>
            </el-avatar>
          </template>
        </el-table-column>
        
        <el-table-column prop="name" label="ÂßìÂêç" width="120">
          <template #default="{ row }">
            <div class="name-cell">
              <span>{{ row.name }}</span>
              <span v-if="row.isGroupLeader" class="leader-crown">üëë</span>
            </div>
          </template>
        </el-table-column>
        
        <el-table-column label="ÂæÆ‰ø°Âè∑" width="150">
          <template #default="{ row }">
            <span v-if="row.social?.wechat">{{ row.social.wechat }}</span>
            <span v-else class="no-data">Êú™ËÆæÁΩÆ</span>
          </template>
        </el-table-column>
        
        <el-table-column prop="location" label="Âú∞Âå∫" width="180">
          <template #default="{ row }">
            <el-tag size="small">{{ row.location }}</el-tag>
          </template>
        </el-table-column>
        
        <el-table-column prop="bio" label="‰∏™‰∫∫‰ªãÁªç" min-width="200" show-overflow-tooltip />
        
        <el-table-column prop="joinDate" label="Âä†ÂÖ•Êó∂Èó¥" width="120" />
        
        <el-table-column prop="tags" label="ÂÖ¥Ë∂£Ê†áÁ≠æ" width="180">
          <template #default="{ row }">
            <el-tag 
              v-for="tag in row.tags?.slice(0, 3)" 
              :key="tag" 
              size="small"
              style="margin-right: 4px; margin-bottom: 2px;"
            >
              {{ tag }}
            </el-tag>
            <span v-if="row.tags?.length > 3" class="more-tags">+{{ row.tags.length - 3 }}</span>
          </template>
        </el-table-column>
        
        <el-table-column label="Êìç‰Ωú" width="200" fixed="right">
          <template #default="{ row }">
            <div class="action-buttons">
              <el-button 
                type="primary" 
                size="small"
                @click="adminEditMember(row)"
              >
                ÁºñËæë
              </el-button>
              <el-button 
                type="success" 
                size="small"
                @click="generateEditLink(row)"
              >
                ÈìæÊé•
              </el-button>
              <el-button 
                type="danger" 
                size="small"
                @click="deleteMember(row)"
              >
                Âà†Èô§
              </el-button>
            </div>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <!-- ËÆæÁΩÆÁæ§‰∏ªÂØπËØùÊ°Ü -->
    <el-dialog 
      v-model="groupLeaderDialogVisible" 
      title="ËÆæÁΩÆÁæ§‰∏ª"
      width="400px"
    >
      <div class="group-leader-selection">
        <p style="margin-bottom: 16px; color: #606266;">ÈÄâÊã©Êñ∞ÁöÑÁæ§‰∏ªÔºö</p>
        <el-select 
          v-model="selectedGroupLeaderId" 
          placeholder="ËØ∑ÈÄâÊã©Áæ§‰∏ª"
          style="width: 100%"
          size="large"
        >
          <el-option
            v-for="member in memberStore.members"
            :key="member.id"
            :label="member.name"
            :value="member.id"
          >
            <div class="member-option-select">
              <span class="member-name">{{ member.name }}</span>
              <img v-if="member.isGroupLeader" src="/crown.png" class="crown-icon-small" />
            </div>
          </el-option>
        </el-select>
      </div>
      
      <template #footer>
        <div class="dialog-footer">
          <el-button @click="groupLeaderDialogVisible = false">ÂèñÊ∂à</el-button>
          <el-button 
            type="primary" 
            @click="confirmSetGroupLeader"
            :disabled="!selectedGroupLeaderId"
          >
            Á°ÆÂÆöËÆæÁΩÆ
          </el-button>
        </div>
      </template>
    </el-dialog>

    <!-- Ê∑ªÂä†/ÁºñËæëÊàêÂëòÂØπËØùÊ°Ü -->
    <el-dialog 
      v-model="dialogVisible" 
      :title="isEditing ? 'ÁºñËæëÊàêÂëò' : 'Ê∑ªÂä†ÊàêÂëò'"
      width="600px"
    >
      <el-form 
        ref="memberFormRef"
        :model="memberForm" 
        :rules="formRules"
        label-width="80px"
      >
        <el-row :gutter="16">
          <el-col :span="12">
            <el-form-item label="ÂßìÂêç" prop="name">
              <el-input v-model="memberForm.name" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="ÂæÆ‰ø°Âè∑">
              <el-input 
                v-model="memberForm.social.wechat" 
                placeholder="ËØ∑ËæìÂÖ•ÂæÆ‰ø°Âè∑"
              />
            </el-form-item>
          </el-col>
        </el-row>
        
        <el-row :gutter="16">
          <el-col :span="12">
            <el-form-item label="Âú∞Âå∫" prop="location">
              <el-input v-model="memberForm.location" placeholder="Â¶ÇÔºö‰∏äÊµ∑Â∏ÇÊµ¶‰∏úÊñ∞Âå∫" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="Âä†ÂÖ•Êó∂Èó¥" prop="joinDate">
              <el-date-picker
                v-model="memberForm.joinDate"
                type="date"
                placeholder="ÈÄâÊã©Âä†ÂÖ•Êó∂Èó¥"
                style="width: 100%"
                format="YYYY-MM-DD"
                value-format="YYYY-MM-DD"
              />
            </el-form-item>
          </el-col>
        </el-row>
        
        <el-form-item label="Â§¥ÂÉèURL" prop="avatar">
          <el-input v-model="memberForm.avatar" placeholder="Â§¥ÂÉèÂõæÁâáÈìæÊé•" />
        </el-form-item>
        
        <el-form-item label="‰∏™‰∫∫‰ªãÁªç" prop="bio">
          <el-input 
            v-model="memberForm.bio" 
            type="textarea" 
            :rows="3"
            placeholder="ÁÆÄÂçï‰ªãÁªç‰∏Ä‰∏ãËá™Â∑±..."
          />
        </el-form-item>
        
        <el-form-item label="Ê†áÁ≠æ" prop="tags">
          <el-select
            v-model="memberForm.tags"
            multiple
            filterable
            allow-create
            placeholder="ÈÄâÊã©ÊàñËæìÂÖ•Ê†áÁ≠æ"
            style="width: 100%"
          >
            <el-option
              v-for="tag in commonTags"
              :key="tag"
              :label="tag"
              :value="tag"
            />
          </el-select>
        </el-form-item>
        
        <el-form-item label="Á§æ‰∫§‰ø°ÊÅØ">
          <el-row :gutter="16">
            <el-col :span="8">
              <el-input 
                v-model="memberForm.social.wechat" 
                placeholder="ÂæÆ‰ø°Âè∑"
                prefix-icon="ChatDotRound"
              />
            </el-col>
            <el-col :span="8">
              <el-input 
                v-model="memberForm.social.github" 
                placeholder="GitHubÁî®Êà∑Âêç"
                prefix-icon="Link"
              />
            </el-col>
            <el-col :span="8">
              <el-input 
                v-model="memberForm.social.linkedin" 
                placeholder="LinkedInÁî®Êà∑Âêç"
                prefix-icon="Link"
              />
            </el-col>
          </el-row>
        </el-form-item>
      </el-form>
      
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="dialogVisible = false">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="saveMember">
            {{ isEditing ? 'Êõ¥Êñ∞' : 'Ê∑ªÂä†' }}
          </el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import { useMemberStore } from '@/stores/members'

const memberStore = useMemberStore()
const router = useRouter()

// Áä∂ÊÄÅ
const searchText = ref('')
const dialogVisible = ref(false)
const isEditing = ref(false)
const memberFormRef = ref()
const groupLeaderDialogVisible = ref(false)
const selectedGroupLeaderId = ref(null)

// Ë°®ÂçïÊï∞ÊçÆ
const memberForm = ref({
  name: '',
  email: '',
  position: '',
  company: '',
  phone: '',
  location: '',
  avatar: '',
  bio: '',
  tags: [],
  social: {
    wechat: '',
    github: '',
    linkedin: ''
  }
})

// Ë°®ÂçïÈ™åËØÅËßÑÂàô
const formRules = {
  name: [{ required: true, message: 'ËØ∑ËæìÂÖ•ÂßìÂêç', trigger: 'blur' }],
  location: [{ required: true, message: 'ËØ∑ËæìÂÖ•Âú∞Âå∫', trigger: 'blur' }]
}

// Â∏∏Áî®Ê†áÁ≠æ
const commonTags = ['ÊäÄÊúØ', '‰∫ßÂìÅ', 'ËÆæËÆ°', 'ËøêËê•', 'Êï∞ÊçÆ', 'Ëê•ÈîÄ', 'ÁÆ°ÁêÜ', 'Âàõ‰∏ö', 'ÊäïËµÑ', 'ÊïôËÇ≤', 'Ëâ∫ÊúØ', 'Èü≥‰πê', 'ÊëÑÂΩ±', 'ÊóÖË°å', 'ËøêÂä®', 'ÁæéÈ£ü', 'ËØª‰π¶', 'ÁîµÂΩ±']

// ËÆ°ÁÆóÂ±ûÊÄß
const filteredTableData = computed(() => {
  if (!searchText.value) return memberStore.members
  
  const keyword = searchText.value.toLowerCase()
  return memberStore.members.filter(member =>
    member.name.toLowerCase().includes(keyword) ||
    member.company.toLowerCase().includes(keyword) ||
    member.position.toLowerCase().includes(keyword) ||
    member.email.toLowerCase().includes(keyword)
  )
})

const locationCount = computed(() => {
  return new Set(memberStore.members.map(m => m.location)).size
})

const thisMonthCount = computed(() => {
  const now = new Date()
  const currentMonth = now.getMonth()
  const currentYear = now.getFullYear()
  
  return memberStore.members.filter(member => {
    const joinDate = new Date(member.joinDate)
    return joinDate.getMonth() === currentMonth && joinDate.getFullYear() === currentYear
  }).length
})

// Ëé∑ÂèñÂΩìÂâçÁæ§‰∏ªÂêçÁß∞
const currentGroupLeaderName = computed(() => {
  const leader = memberStore.getGroupLeader()
  return leader ? leader.name : 'ÊöÇÊó†Áæ§‰∏ª'
})

// ÊñπÊ≥ï
const showAddDialog = () => {
  isEditing.value = false
  resetForm()
  dialogVisible.value = true
}

// ÁÆ°ÁêÜÂëòÁõ¥Êé•ÁºñËæëÔºàÁªïËøátokenÊ†°È™åÔºâ
const adminEditMember = (member) => {
  router.push(`/edit/admin/${member.id}`)
}

// ÁîüÊàêÁºñËæëÈìæÊé•ÁªôÁæ§Âèã‰ΩøÁî®
const goToEditPage = async (member) => {
  try {
    const token = await memberStore.generateEditToken(member.id)
    router.push(`/edit/${token}?admin=true`)
  } catch (error) {
    ElMessage.error('ÁîüÊàêÁºñËæë‰ª§ÁâåÂ§±Ë¥•: ' + error.message)
  }
}

const goToMessageManagement = () => {
  router.push('/admin/messages')
}

// ÊòæÁ§∫Áæ§‰∏ªËÆæÁΩÆÂØπËØùÊ°Ü
const showGroupLeaderDialog = () => {
  const currentLeader = memberStore.getGroupLeader()
  selectedGroupLeaderId.value = currentLeader ? currentLeader.id : null
  groupLeaderDialogVisible.value = true
}

// Á°ÆËÆ§ËÆæÁΩÆÁæ§‰∏ª
const confirmSetGroupLeader = async () => {
  if (selectedGroupLeaderId.value) {
    try {
      await memberStore.setGroupLeader(selectedGroupLeaderId.value)
      const member = memberStore.getMemberById(selectedGroupLeaderId.value)
      ElMessage.success(`${member.name} Â∑≤ËÆæÁΩÆ‰∏∫Áæ§‰∏ª`)
      groupLeaderDialogVisible.value = false
    } catch (error) {
      ElMessage.error('ËÆæÁΩÆÁæ§‰∏ªÂ§±Ë¥•: ' + error.message)
    }
  }
}



const resetForm = () => {
  memberForm.value = {
    name: '',
    location: '',
    avatar: '',
    bio: '',
    tags: [],
    joinDate: new Date().toISOString().split('T')[0], // ÈªòËÆ§‰∏∫‰ªäÂ§©
    social: {
      wechat: ''
    }
  }
}

const saveMember = async () => {
  try {
    await memberFormRef.value.validate()
    
    if (isEditing.value) {
      await memberStore.updateMember(memberForm.value.id, memberForm.value)
      ElMessage.success('ÊàêÂëò‰ø°ÊÅØÊõ¥Êñ∞ÊàêÂäü')
    } else {
      await memberStore.addMember(memberForm.value)
      ElMessage.success('ÊàêÂëòÊ∑ªÂä†ÊàêÂäü')
    }
    
    dialogVisible.value = false
  } catch (error) {
    ElMessage.error('Êìç‰ΩúÂ§±Ë¥•: ' + error.message)
  }
}

const deleteMember = (member) => {
  ElMessageBox.confirm(
    `Á°ÆÂÆöË¶ÅÂà†Èô§ÊàêÂëò "${member.name}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`,
    'Á°ÆËÆ§Âà†Èô§',
    {
      confirmButtonText: 'Âà†Èô§',
      cancelButtonText: 'ÂèñÊ∂à',
      type: 'warning',
    }
  ).then(async () => {
    try {
      await memberStore.deleteMember(member.id)
      ElMessage.success('Âà†Èô§ÊàêÂäü')
    } catch (error) {
      ElMessage.error('Âà†Èô§Â§±Ë¥•: ' + error.message)
    }
  })
}

const generateEditLink = async (member) => {
  try {
    const token = await memberStore.generateEditToken(member.id)
    const editUrl = `${window.location.origin}/edit/${token}`
    
    ElMessageBox.alert(
      `ÁºñËæëÈìæÊé•: ${editUrl}`,
      `‰∏∫ ${member.name} ÁîüÊàêÁºñËæëÈìæÊé•`,
      {
        confirmButtonText: 'Â§çÂà∂ÈìæÊé•',
        callback: () => {
          navigator.clipboard.writeText(editUrl).then(() => {
            ElMessage.success('ÁºñËæëÈìæÊé•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø')
          })
        }
      }
    )
  } catch (error) {
    ElMessage.error('ÁîüÊàêÁºñËæëÈìæÊé•Â§±Ë¥•: ' + error.message)
  }
}

// ÁîüÂëΩÂë®Êúü
onMounted(async () => {
  await memberStore.loadMembers()
})
</script>

<style scoped>
.admin-panel {
  max-width: 1200px;
  margin: 0 auto;
}

.page-header {
  background: white;
  padding: 24px 32px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  margin-bottom: 24px;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-left h1 {
  margin: 0 0 8px 0;
  font-size: 24px;
  font-weight: 600;
  color: #1f2937;
}

.subtitle {
  margin: 0;
  color: #6b7280;
  font-size: 14px;
}

.stats-row {
  margin-bottom: 24px;
}

.stat-card {
  text-align: center;
}

.table-card {
  margin-bottom: 24px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.more-tags {
  color: #909399;
  font-size: 12px;
}

.no-data {
  color: #c0c4cc;
  font-style: italic;
  font-size: 12px;
}

.name-cell {
  display: flex;
  align-items: center;
  gap: 6px;
}

.leader-crown {
  font-size: 16px;
  line-height: 1;
}

/* Áæ§‰∏ªËÆæÁΩÆÂØπËØùÊ°ÜÊ†∑Âºè */
.group-leader-selection {
  padding: 16px 0;
}

.member-option-select {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.member-name {
  font-size: 14px;
  font-weight: 500;
  color: #303133;
}

.crown-icon-small {
  width: 14px;
  height: 14px;
  margin-left: 8px;
}

/* Êìç‰ΩúÊåâÈíÆÊ†∑Âºè */
.action-buttons {
  display: flex;
  gap: 6px;
  flex-wrap: nowrap;
}

.action-buttons .el-button {
  flex-shrink: 0;
  min-width: auto;
  padding: 4px 8px;
}

.dialog-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
  }
  
  .stats-row .el-col {
    margin-bottom: 16px;
  }
  
  .card-header {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }
}
</style>
